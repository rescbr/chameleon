include ${SRCROOT}/Make.rules

ifneq "" "$(wildcard /bin/mkdirs)"
  MKDIRS = /bin/mkdirs
else
  MKDIRS = /bin/mkdir -p
endif

NATIVE_AS = as
NATIVE_LD = ld
NATIVE_CC = cc
NATIVE_CPP = g++
PAX = /bin/pax

$(OBJROOT)/%.o: %.c $(OBJROOT)
	@echo "\t[CC] $<"
	@$(NATIVE_CC) $(CFLAGS) $(DEFINES) -c $(INC) $< -o $@ \
	    -MD -dependency-file $(OBJROOT)/$*.d
	@md -u $(OBJROOT)/Makedep -f -d $(OBJROOT)/$*.d

$(OBJROOT)/%.o: %.m $(OBJROOT)
	@echo "\t[M] $<"
	@$(NATIVE_CC) $(CFLAGS) $(DEFINES) -c $(INC) $< -o $@ \
	    -MD -dependency-file $(OBJROOT)/$*.d
	@md -u $(OBJROOT)/Makedep -f -d $(OBJROOT)/$*.d

$(OBJROOT)/%.o: %.cpp $(OBJROOT)
	@echo "\t[CPP] $<"
	@$(NATIVE_CPP) $(CPPFLAGS) $(CFLAGS) -c "$<" $(INC) -o $@ \
	    -MD -dependency-file $(OBJROOT)/$*.d
	@md -u $(OBJROOT)/Makedep -f -d $(OBJROOT)/$*.d


$(DIRS_NEEDED) $(INSTALLDIR) $(OBJROOT) $(SYMROOT):
	@echo "\t[MKDIR] $@"
	@$(MKDIRS) $@
		
config: $(DIRS_NEEDED)
	@echo "\t[MAKE] config"
	@cd ${SRCROOT}/config/ && make
	@echo "\t[CCONFIG] config"
	@cd ${SRCROOT} && $(SYMROOT)/cconfig $(SRCROOT)/Cconfig

rebuild_config: $(DIRS_NEEDED)
	@echo "\t[MAKE] config"
	@cd ${SRCROOT}/config/ && make
	@echo "\t[CCONFIG] reconfig"
	@cd ${SRCROOT} && $(SYMROOT)/cconfig $(SRCROOT)/Cconfig rebuild


.PHONY: config
.PHONY: rebuild_config
.PHONY: $(SRCROOT)/auto.conf

$(SYMROOT)/vers.h:
	@echo "#define BOOT_VERSION \"5.0.132\"" > $@
	@echo "#define BOOT_BUILDDATE \"`date \"+%Y-%m-%d %H:%M:%S\"`\"" >> $@
	@echo "#define BOOT_CHAMELEONVERSION \"$$VERSION\"" >> $@
	@echo "#define BOOT_CHAMELEONREVISION \"$$REVISION\"" >> $@


clean:
	@echo "\t[RM] $(OBJROOT)"
	@echo "\t[RM] $(SYMROOT)"
	@echo "\t[RM] $(DSTROOT)"
	@echo "\t[RM] $(SRCROOT)/auto.conf"
	@echo "\t[RM] $(SRCROOT)/autoconf.h"
	@echo "\t[RM] $(SRCROOT)/autoconf.inc"

	@rm -rf $(OBJROOT) $(SYMROOT) $(DSTROOT) \
			$(SRCROOT)/auto.conf \
			$(SRCROOT)/autoconf.h \
			$(SRCROOT)/autoconf.inc

$(SRCROOT)/auto.conf $(SRCROOT)/autoconf.h $(SRCROOT)/autoconf.inc $(SRCROOT)/.config: rebuild_cofig

.PHONY: rebuild_config
.PHONY: config
.PHONY: clean
.PHONY: $(SYMROOT)/vers.h


.DEFAULT_GOAL := all
